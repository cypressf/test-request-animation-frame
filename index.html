<!DOCTYPE html>

<title>Test animation</title>
<meta name="color-scheme" content="light dark">

<style>
    .item {
        position: absolute;
        background-color: gray;
        width: 10px;
        height: 10px;
        border-radius: 5px;
    }

    h3 {
        margin: 1em 0 0
    }
</style>


<h3>Time</h3>
<div id=debugTime></div>

<h3>Positions</h3>
<table id=debugPositions></table>

<h3>Velocities</h3>
<table id=debugVelocities></table>

<h3>Click</h3>
<table id=debugClicks></table>

<script> // @ts-check
    /**
     * @typedef {Object} Position
     * @property {number} x
     * @property {number} y
     */

    // Initial state
    const positions = [
        { x: 400, y: 600 },
        { x: 600, y: 400 },
        { x: 350, y: 300 },
    ]
    const velocities = [
        { x: 0, y: 0 },
        { x: 10, y: 10 },
        { x: 20, y: -20 }
    ]
    const masses = [20, 20, 10]


    // Helper functions
    const round = Intl.NumberFormat("en-US", { maximumFractionDigits: 2, minimumFractionDigits: 2 })
    const formatPositions = (/** @type {Position[]} */ positions) => {
        let output = ""
        for (const position of positions) {
            output += `<tr>
                <td>${round.format(position.x)}</td>
                <td>${round.format(position.y)}</td>
            </tr>`
        }
        return output
    }

    // DOM
    /** @type {HTMLDivElement[]} */
    const domNodes = []
    const addDomNode = () => {
        const div = document.createElement("div")
        div.className = 'item'
        document.body.append(div)
        domNodes.push(div)
    }
    for (let i = 0; i < positions.length; i++) {
        addDomNode()
    }

    const addItem = (/** @type {Position} */ position) => {
        velocities.push({ x: 0, y: 0 })
        positions.push(position)
        masses.push(Math.random() * 200)
        addDomNode()
    }

    document.addEventListener("click", event => {
        const position = { x: event.pageX, y: event.pageY }
        //@ts-ignore
        debugClicks.innerHTML = formatPositions([position])
        addItem(position)
    })

    // Animation function
    let prevTime = 0
    const animate = time => {
        const delta = (time - prevTime) / 1000
        prevTime = time

        for (let i = 0; i < positions.length; i++) {

            // Add the forces to velocity
            for (let j = 0; j < positions.length; j++) {
                if (i === j) continue

                const xDelta = positions[j].x - positions[i].x
                const yDelta = positions[j].y - positions[i].y
                const distance = Math.sqrt(xDelta ** 2 + yDelta ** 2)
                const attraction = masses[j] + masses[i]
                const direction = { x: xDelta, y: yDelta }

                velocities[i].x += direction.x * delta * attraction / distance / masses[i]
                velocities[i].y += direction.y * delta * attraction / distance / masses[i]
            }

            // Add the velocity to position
            positions[i].x += delta * velocities[i].x
            positions[i].y += delta * velocities[i].y
        }

        // @ts-ignore
        debugTime.innerHTML = time
        // @ts-ignore
        debugPositions.innerHTML = formatPositions(positions)
        // @ts-ignore
        debugVelocities.innerHTML = formatPositions(velocities)

        for (let i = 0; i < positions.length; i++) {
            domNodes[i].style.left = `${positions[i].x}px`
            domNodes[i].style.top = `${positions[i].y}px`
        }

        requestAnimationFrame(animate)
    }

    animate(0)
</script>