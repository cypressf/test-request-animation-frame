<!DOCTYPE html>

<title>Test animation</title>
<meta name="color-scheme" content="light dark">

<style>
    .item {
        position: absolute;
        background-color: gray;
        width: 10px;
        height: 10px;
        border-radius: 5px;
    }

    h3 {
        margin: 1em 0 0
    }
</style>


<h3>Time</h3>
<div id=debug-time></div>

<h3>Positions</h3>
<table id=debug-positions></table>

<h3>Velocities</h3>
<table id=debug-velocities></table>

<script> // @ts-check
    /**
     * @typedef {Object} Position
     * @property {number} x
     * @property {number} y
     */

    // pixels
    const positions = [
        { x: 400, y: 600 },
        { x: 300, y: 700 },
        { x: 250, y: 300 },
    ]

    // pixels per second
    const velocities = [
        { x: 0, y: 0 },
        { x: 10, y: 10 },
        { x: 200, y: -200 }
    ]

    const masses = [2000, 20, 10]

    const numItems = positions.length

    let domNodes = []
    for (let i = 0; i < numItems; i++) {
        const div = document.createElement("div")
        div.className = 'item'
        document.body.append(div)
        domNodes[i] = div
    }

    const debugTime = document.querySelector("#debug-time")
    const debugPositions = document.querySelector("#debug-positions")
    const debugVelocities = document.querySelector("#debug-velocities")
    if (!debugTime || !debugPositions || !debugVelocities) throw Error()

    const round = Intl.NumberFormat("en-US", { maximumFractionDigits: 2, minimumFractionDigits: 2 })

    const prettyPositions = (/** @type {Position[]} */ positions) => {
        let output = ""
        for (let i = 0; i < numItems; i++) {
            output += `<tr><td>${round.format(positions[i].x)}</td><td>${round.format(positions[i].y)}</td></tr>`
        }
        return output
    }

    let prevTime = 0

    const animate = time => {
        const delta = (time - prevTime) / 1000
        prevTime = time

        for (let i = 0; i < numItems; i++) {

            // Add the forces exerted by all the other items to the velocity
            for (let j = 0; j < numItems; j++) {
                if (i === j) continue
                const xDelta = positions[j].x - positions[i].x
                const yDelta = positions[j].y - positions[i].y
                const distance = Math.sqrt(xDelta ** 2 + yDelta ** 2)
                const attraction = masses[j] + masses[i]
                const direction = { x: xDelta, y: yDelta }

                velocities[i].x += direction.x * delta * attraction / distance / masses[i]
                velocities[i].y += direction.y * delta * attraction / distance / masses[i]
            }

            // Add the velocity to the position
            positions[i].x += delta * velocities[i].x
            positions[i].y += delta * velocities[i].y
        }

        debugTime.innerHTML = time
        debugPositions.innerHTML = prettyPositions(positions)
        debugVelocities.innerHTML = prettyPositions(velocities)

        for (let i = 0; i < numItems; i++) {
            domNodes[i].style.left = `${positions[i].x}px`
            domNodes[i].style.top = `${positions[i].y}px`
        }
        requestAnimationFrame(animate)
    }

    animate(0)
</script>